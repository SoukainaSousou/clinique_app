name: CI/CD DevSecOps - Clinique (Tests tolérants)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: clinique-backend
  IMAGE_NAME_FRONTEND: clinique-frontend
  VERSION: ${{ github.sha }}
  TRIVY_VERSION: "0.51.1"
  # Convertir le nom du repository owner en minuscules
  REPO_OWNER_LOWER: ${{ lower(github.repository_owner) }}

jobs:
  # ----------------------------
  # JOB 1: COMPILATION ET TESTS (tolérants)
  # ----------------------------
  build-and-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: clinique_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -uroot -prootpassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('clinique/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Étape 1: Compilation obligatoire
      - name: Compile Backend
        run: |
          cd clinique
          mvn clean compile -B

      # Étape 2: Tests (avec continue-on-error pour permettre la suite)
      - name: Run Tests
        run: |
          cd clinique
          mvn test -B \
            -Dspring.profiles.active=test \
            -Dspring.datasource.url=jdbc:mysql://localhost:3306/clinique_db \
            -Dspring.datasource.username=root \
            -Dspring.datasource.password=rootpassword \
            -Dmaven.test.failure.ignore=true
        continue-on-error: true

      # Étape 3: Construction du JAR (toujours exécutée)
      - name: Build JAR Package
        run: |
          cd clinique
          mvn clean package -B -DskipTests=true

      # Frontend
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: clinique-frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd clinique-frontend
          npm ci --no-audit

      - name: Build Frontend
        run: |
          cd clinique-frontend
          CI=false npm run build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            clinique/target/*.jar
            clinique-frontend/build/
          retention-days: 7

  # ----------------------------
  # JOB 2: SCAN DE SÉCURITÉ
  # ----------------------------
  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          tar -xzf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/

      - name: Scan Backend Dependencies
        run: |
          cd clinique
          trivy fs --exit-code 0 --severity HIGH,CRITICAL .
          echo "Backend security scan completed"

      - name: Scan Frontend Dependencies
        run: |
          cd clinique-frontend
          trivy fs --exit-code 0 --severity HIGH,CRITICAL .
          echo "Frontend security scan completed"

  # ----------------------------
  # JOB 3: DOCKER BUILD ET PUSH
  # ----------------------------
  docker-build:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      - name: Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Backend Docker
      - name: Build Backend Docker Image
        run: |
          cd clinique
          echo "Building backend image..."
          docker build \
            --tag ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_BACKEND }}:${{ env.VERSION }} \
            --tag ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_BACKEND }}:latest \
            .

      - name: Scan Backend Docker Image
        run: |
          trivy image \
            --exit-code 0 \
            --severity HIGH,CRITICAL \
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_BACKEND }}:${{ env.VERSION }}

      # Frontend Docker
      - name: Build Frontend Docker Image
        run: |
          cd clinique-frontend
          echo "Building frontend image..."
          docker build \
            --tag ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ env.VERSION }} \
            --tag ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_FRONTEND }}:latest \
            .

      - name: Scan Frontend Docker Image
        run: |
          trivy image \
            --exit-code 0 \
            --severity HIGH,CRITICAL \
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ env.VERSION }}

      # Push images seulement sur main
      - name: Push Images to GHCR
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Pushing backend image..."
          docker push ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_BACKEND }}:${{ env.VERSION }}
          docker push ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          
          echo "Pushing frontend image..."
          docker push ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ env.VERSION }}
          docker push ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
          
          echo "Images pushed successfully!"

  # ----------------------------
  # JOB 4: TESTS D'INTÉGRATION DOCKER COMPOSE (Optionnel)
  # ----------------------------
  integration-tests:
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      - name: Create .env file for integration test
        run: |
          cat > .env << 'EOF'
          MYSQL_ROOT_PASSWORD=rootpassword
          MYSQL_DATABASE=clinique_db
          SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/clinique_db
          SPRING_DATASOURCE_USERNAME=root
          SPRING_DATASOURCE_PASSWORD=rootpassword
          REACT_APP_API_URL=http://backend:8080
          EOF

      - name: Create docker-compose.test.yml
        run: |
          cat > docker-compose.test.yml << 'EOF'
          version: '3.8'

          services:
            mysql:
              image: mysql:8.0
              container_name: test-mysql
              environment:
                MYSQL_ROOT_PASSWORD: rootpassword
                MYSQL_DATABASE: clinique_db
              ports:
                - "3307:3306"
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-prootpassword"]
                timeout: 30s
                retries: 10
              networks:
                - test-network

            backend:
              image: ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_BACKEND }}:latest
              container_name: test-backend
              ports:
                - "8081:8080"
              depends_on:
                mysql:
                  condition: service_healthy
              environment:
                SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/clinique_db?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC&allowPublicKeyRetrieval=true&useSSL=false
                SPRING_DATASOURCE_USERNAME: root
                SPRING_DATASOURCE_PASSWORD: rootpassword
                SPRING_PROFILES_ACTIVE: test
              networks:
                - test-network

            frontend:
              image: ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
              container_name: test-frontend
              ports:
                - "3001:80"
              depends_on:
                - backend
              environment:
                REACT_APP_API_URL: http://backend:8080
              networks:
                - test-network

          networks:
            test-network:
              driver: bridge
          EOF

      - name: Run Integration Tests
        run: |
          echo "Starting integration test..."
          docker-compose -f docker-compose.test.yml up -d
          sleep 30
          
          echo "Checking backend health..."
          curl -f http://localhost:8081/actuator/health || (echo "Backend health check failed" && exit 1)
          
          echo "Checking frontend accessibility..."
          curl -f http://localhost:3001 || echo "Frontend check completed"
          
          echo "Integration test passed!"
          docker-compose -f docker-compose.test.yml down -v

      - name: Cleanup on failure
        if: failure()
        run: |
          docker-compose -f docker-compose.test.yml down -v || true